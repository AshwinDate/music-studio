<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<title>Indian Classical Music Studio</title>

<!-- Premium Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Hind:wght@400;500;600&family=Noto+Serif+Display:wght@500;600;700&display=swap" rel="stylesheet">

<style>

    /* ==== GLOBAL THEME ==== */
    body {
        margin: 0;
        padding: 20px;
        background: url("background.jpg") center/cover fixed;
        font-family: "Hind", sans-serif;
        color: #3c2f1e;
    }

    h1 {
        text-align: center;
        font-size: 48px;
        margin-bottom: 35px;
        color: #4b3116;
        font-family: "Noto Serif Display", serif;
        text-shadow: 0px 0px 8px rgba(255,215,0,0.5);
        letter-spacing: 1px;
    }

    h2 {
        margin-top: 0;
        font-size: 26px;
        font-family: "Noto Serif Display", serif;
        color: #4b3116;
        border-left: 6px solid #d1a84c;
        padding-left: 12px;
        margin-bottom: 18px;
    }

    /* ==== SECTION CARDS ==== */
    .section {
        padding: 25px;
        margin: 25px auto;
        width: 92%;
        background: linear-gradient(135deg, #fff6e8, #fcefdc);
        border-radius: 18px;
        border: 2px solid #d3a24b;
        box-shadow: 0 0 20px rgba(0,0,0,0.25);
    }

    /* ==== GOLD BUTTONS ==== */
    .btn {
        padding: 12px 26px;
        border-radius: 40px;
        font-size: 17px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #4b3116;
        background: linear-gradient(135deg, #f7d78a, #eac46c);
        box-shadow: inset 0 0 8px #fff3c4, 0 4px 12px rgba(0,0,0,0.2);
        transition: 0.2s ease;
    }

    .btn:hover {
        transform: scale(1.05);
        box-shadow: inset 0 0 8px #fff3c4, 0 6px 16px rgba(0,0,0,0.3);
    }

    .btn.stop {
        background: linear-gradient(135deg, #d2775a, #c2553b);
        color: #fff2e9;
    }

    /* ==== SELECTS & SLIDERS ==== */
    select, input[type=range] {
        padding: 8px 12px;
        font-size: 16px;
        border-radius: 10px;
        border: 2px solid #d3a24b;
        background: #fff9ef;
        color: #4b3116;
    }

    #tanpuraVol, #tablaVol { width: 220px; }

</style>

</head>

<body>

<h1>Indian Classical Music Studio</h1>


<!-- ============= PITCH DETECTION ============= -->
<div class="section">
    <h2>üé§ Pitch Detection (Your SA)</h2>

    <button class="btn" onclick="startPitchDetection()">‚ñ∂ Start Listening</button>

    <p>Detected SA:
       <span id="detectedSa" style="font-size:26px;color:#b8860b;">--</span>
    </p>
</div>


<!-- ============= TANPURA ============= -->
<div class="section">
    <h2>üé∂ Tanpura (Auto-Tuned)</h2>

    <label style="font-weight:600;">Volume:</label>
    <input type="range" id="tanpuraVol" min="0" max="1" step="0.01" value="0.8" oninput="updateTanpuraVolume()">
    <br><br>

    <button class="btn" onclick="startTanpuraAuto()">‚ñ∂ Start Tanpura</button>
    <button class="btn stop" onclick="stopTanpura()">‚èπ Stop Tanpura</button>
</div>


<!-- ============= TABLA ============= -->
<div class="section">
    <h2>ü•Å Tabla</h2>

    <select id="tablaTaal">
        <option value="teentaal">Teentaal</option>
        <option value="dadra">Dadra</option>
        <option value="ektal">Ektaal</option>
        <option value="rupak">Rupak</option>
        <option value="jhaptal">Jhaptal</option>
        <option value="bhajani">Bhajani</option>
    </select>

    <br><br>
    <label style="font-weight:600;">Volume:</label>
    <input type="range" id="tablaVol" min="0" max="1" step="0.01" value="1" oninput="updateTablaVolume()">

    <br><br>
    <button class="btn" onclick="startTabla()">‚ñ∂ Start Tabla</button>
    <button class="btn stop" onclick="stopTabla()">‚èπ Stop Tabla</button>
</div>


<!-- ============= SURPETI ============= -->
<div class="section">
    <h2>üéπ Surpeti (Auto-Tuned)</h2>
    <button class="btn" onclick="startSurpeti()">‚ñ∂ Start Surpeti</button>
    <button class="btn stop" onclick="stopSurpeti()">‚èπ Stop Surpeti</button>
</div>


<!-- ============= SWARMANDAL ============= -->
<div class="section">
    <h2>‚ú® Swarmandal (Auto-Tuned + Auto Start)</h2>

    <select id="swarmandalRaag" onchange="scheduleSwarmandal()">
        <option value="none">Select Raag</option>
        <option value="yaman">Yaman</option>
        <option value="des">Des</option>
        <option value="nand">Nand</option>
    </select>

    <br><br>
    <button class="btn" onclick="playSwarmandal()">‚ñ∂ Play Swarmandal</button>
    <button class="btn stop" onclick="stopSwarmandal()">‚èπ Stop Swarmandal</button>
</div>




<!-- ===================================================================================== -->
<!-- ===============================  FULL JAVASCRIPT =================================== -->
<!-- ===================================================================================== -->

<script>

/* -------------------------------------------------------
   GLOBAL VARIABLES (unchanged except added tablaGain)
--------------------------------------------------------*/
let tanpuraCtx, tanpuraSrc, tanpuraGain;
let tablaCtx, tablaSrc, tablaGain;
let surpetiCtx, surpetiSrc;
let swarmandalCtx, swarmandalSrc;

let micCtx, micStream;
let currentScale = null;
let swarmandalTimer = null;


/* -------------------------------------------------------
   UTILITIES
--------------------------------------------------------*/
function fixNoteName(n){ return n.replace("#","sharp"); }

function getScaleRatio(note) {
    const N = ["C","Csharp","D","Dsharp","E","F","Fsharp","G","Gsharp","A","Asharp","B"];
    return Math.pow(2, N.indexOf(note) / 12);
}

function freqToNoteName(freq){
    const N=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    let n=Math.round(12*Math.log(freq/440)/Math.log(2))+57;
    return N[n%12];
}


/* -------------------------------------------------------
   YIN PITCH DETECTION ‚Äî HIGH ACCURACY
--------------------------------------------------------*/
function yin(buffer, sampleRate) {
    let threshold = 0.15;
    let tauMax = buffer.length / 2;
    let yinBuffer = new Float32Array(tauMax);

    // Step 1: Difference function
    for (let tau = 1; tau < tauMax; tau++) {
        let sum = 0;
        for (let i = 0; i < tauMax; i++) {
            let diff = buffer[i] - buffer[i+tau];
            sum += diff * diff;
        }
        yinBuffer[tau] = sum;
    }

    // Step 2: Cumulative mean normalized difference
    yinBuffer[0] = 1;
    let runningSum = 0;

    for (let tau = 1; tau < tauMax; tau++) {
        runningSum += yinBuffer[tau];
        yinBuffer[tau] *= tau / runningSum;
    }

    // Step 3: Absolute threshold
    let tauEstimate = -1;
    for (let tau = 2; tau < tauMax; tau++) {
        if (yinBuffer[tau] < threshold) {
            tauEstimate = tau;
            break;
        }
    }

    if (tauEstimate === -1) return null;

    // Step 4: Parabolic interpolation (for accuracy)
    let betterTau = tauEstimate;

    if (tauEstimate > 1 && tauEstimate < tauMax - 1) {
        let s0 = yinBuffer[tauEstimate - 1];
        let s1 = yinBuffer[tauEstimate];
        let s2 = yinBuffer[tauEstimate + 1];
        let shift = (s2 - s0) / (2 * (2*s1 - s2 - s0));
        betterTau = tauEstimate + shift;
    }

    return sampleRate / betterTau;
}


/* -------------------------------------------------------
   START YIN PITCH DETECTION
--------------------------------------------------------*/
function startPitchDetection() {

    navigator.mediaDevices.getUserMedia({audio:true})
        .then(stream => {

            micCtx = new AudioContext();
            micStream = micCtx.createMediaStreamSource(stream);

            const analyser = micCtx.createAnalyser();
            analyser.fftSize = 2048;

            micStream.connect(analyser);

            let buf = new Float32Array(analyser.fftSize);

            function loop() {
                analyser.getFloatTimeDomainData(buf);

                let f = yin(buf, micCtx.sampleRate);

                if (f && f > 60 && f < 1200) {
                    let note = freqToNoteName(f);
                    document.getElementById("detectedSa").innerText = note;
                    currentScale = fixNoteName(note);
                }

                requestAnimationFrame(loop);
            }

            loop();
        });
}



/* -------------------------------------------------------
   TANPURA (unchanged except volume)
--------------------------------------------------------*/
async function startTanpuraAuto(){
    stopTanpura();

    let sa=document.getElementById("detectedSa").innerText;
    if(sa==="--"){ alert("Detect SA first!"); return; }

    currentScale = fixNoteName(sa);
    let file=`audio/tanpura/${currentScale}.mp3`;

    tanpuraCtx = new AudioContext();
    tanpuraGain = tanpuraCtx.createGain();
    tanpuraGain.gain.value = document.getElementById("tanpuraVol").value;

    const arr=await fetch(file).then(r=>r.arrayBuffer());
    const buf=await tanpuraCtx.decodeAudioData(arr);

    tanpuraSrc = tanpuraCtx.createBufferSource();
    tanpuraSrc.buffer = buf;
    tanpuraSrc.loop = true;

    tanpuraSrc.connect(tanpuraGain).connect(tanpuraCtx.destination);
    tanpuraSrc.start();
}

function updateTanpuraVolume(){
    if(tanpuraGain){
        tanpuraGain.gain.value = document.getElementById("tanpuraVol").value;
    }
}

function stopTanpura(){
    try{ tanpuraSrc.stop(); }catch(e){}
    try{ tanpuraCtx.close(); }catch(e){}
}



/* -------------------------------------------------------
   TABLA WITH VOLUME SLIDER
--------------------------------------------------------*/
async function startTabla(){
    stopTabla();

    let taal=document.getElementById("tablaTaal").value;

    let target=currentScale || "E";
    let base="E";

    let ratio = getScaleRatio(target)/getScaleRatio(base);

    tablaCtx=new AudioContext();
    tablaGain=tablaCtx.createGain();
    tablaGain.gain.value=document.getElementById("tablaVol").value;

    const arr=await fetch(`audio/tabla/${taal}/base.mp3`).then(r=>r.arrayBuffer());
    const buf=await tablaCtx.decodeAudioData(arr);

    tablaSrc = tablaCtx.createBufferSource();
    tablaSrc.buffer=buf;
    tablaSrc.loop=true;
    tablaSrc.playbackRate.value = ratio; 

    tablaSrc.connect(tablaGain).connect(tablaCtx.destination);
    tablaSrc.start();
}

function updateTablaVolume(){
    if(tablaGain){
        tablaGain.gain.value = document.getElementById("tablaVol").value;
    }
}

function stopTabla(){
    try{ tablaSrc.stop(); }catch(e){}
    try{ tablaCtx.close(); }catch(e){}
}



/* -------------------------------------------------------
   SURPETI
--------------------------------------------------------*/
async function startSurpeti(){
    stopSurpeti();
    let scale=currentScale||"E";
    let ratio=getScaleRatio(scale)/getScaleRatio("E");

    surpetiCtx=new AudioContext();

    const arr=await fetch("audio/surpeti/base.mp3").then(r=>r.arrayBuffer());
    const buf=await surpetiCtx.decodeAudioData(arr);

    surpetiSrc=surpetiCtx.createBufferSource();
    surpetiSrc.buffer=buf;
    surpetiSrc.loop=true;
    surpetiSrc.playbackRate.value=ratio;
    surpetiSrc.connect(surpetiCtx.destination);
    surpetiSrc.start();
}

function stopSurpeti(){
    try{ surpetiSrc.stop(); }catch(e){}
    try{ surpetiCtx.close(); }catch(e){}
}



/* -------------------------------------------------------
   SWARMANDAL
--------------------------------------------------------*/
function scheduleSwarmandal(){
    clearTimeout(swarmandalTimer);
    if(document.getElementById("swarmandalRaag").value!=="none"){
        swarmandalTimer=setTimeout(playSwarmandal,60000);
    }
}

async function playSwarmandal(){
    stopSwarmandal();

    let raag=document.getElementById("swarmandalRaag").value;
    if(raag==="none") return;

    let scale=currentScale||"E";
    let ratio=getScaleRatio(scale)/getScaleRatio("E");

    swarmandalCtx=new AudioContext();

    const arr=await fetch(`audio/swarmandal/${raag}/base.mp3`).then(r=>r.arrayBuffer());
    const buf=await swarmandalCtx.decodeAudioData(arr);

    swarmandalSrc=swarmandalCtx.createBufferSource();
    swarmandalSrc.buffer=buf;
    swarmandalSrc.playbackRate.value=ratio;
    swarmandalSrc.connect(swarmandalCtx.destination);
    swarmandalSrc.start();
}

function stopSwarmandal(){
    try{ swarmandalSrc.stop(); }catch(e){}
    try{ swarmandalCtx.close(); }catch(e){}
}

</script>

</body>
</html>
